@page "/settings"
@using DataLibrary.Settings;
@using Microsoft.AspNetCore.Components.Forms;
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.Extensions.Options;
@using System.Text.Json;
@using System.Text.Json.Nodes;
@inject IOptionsMonitor<DriverPathSettings> pathSettings

<PageTitle>Settings</PageTitle>
<div class="row mb-3 mt-3">
    <div class="column mb-3 mt-3">
        <div class="container mt-3">
            <div>
                <button class="btn btn-primary" @onclick="LoadGeckoDriver">GeckoDriver</button>
                <label style="color:green">@pathSettings.CurrentValue.GeckoDriverPath</label>
                <button class="btn btn-secondary" @onclick="ClearGeckoDriver">Clear</button>
            </div>
            <br />
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxALLEProfile">ALLE Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxALLEProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxALLEProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxANNEProfile">ANNE Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxANNEProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxANNEProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxBACIProfile">BACI Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxBACIProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxBACIProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxBACOProfile">BACO Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxBACOProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxBACOProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxCALVProfile">CALV Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxCALVProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxCALVProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxCAROProfile">CARO Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxCAROProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxCAROProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxCARRProfile">CARR Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxCARRProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxCARRProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxCECIProfile">CECI Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxCECIProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxCECIProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxCHARProfile">CHAR Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxCHARProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxCHARProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxDORCProfile">DORC Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxDORCProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxDORCProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxFREDProfile">FRED Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxFREDProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxFREDProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxGARRProfile">GARR Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxGARRProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxGARRProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxHARFProfile">HARF Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxHARFProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxHARFProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxHOWAProfile">HOWA Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxHOWAProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxHOWAProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxKENTProfile">KENT Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxKENTProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxKENTProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxMONTProfile">MONT Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxMONTProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxMONTProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxPRINProfile">PRIN Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxPRINProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxPRINProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxQUEEProfile">QUEE Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxQUEEProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxQUEEProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxSOMEProfile">SOME Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxSOMEProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxSOMEProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxSTMAProfile">STMA Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxSTMAProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxSTMAProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxTALBProfile">TALB Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxTALBProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxTALBProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxWASHProfile">WASH Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxWASHProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxWASHProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxWICOProfile">WICO Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxWICOProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxWICOProfile">Clear</button> 
            </div>
            <div>
                <button class="btn btn-primary" @onclick="LoadFirefoxWORCProfile">WORC Profile</button>
                <label style="color:green">@pathSettings.CurrentValue.FirefoxWORCProfilePath</label>
                <button class="btn btn-secondary" @onclick="ClearFirefoxWORCProfile">Clear</button> 
            </div>
        </div>
    </div>
</div>

@if (ErrorsList.Count > 0)
{
    <h2>ErrorsList</h2>
    <ul class="text-danger">
        @foreach (var error in ErrorsList)
        {
            <li>@error</li>
        }
    </ul>
}

@code {
    private List<string> ErrorsList = new();

    protected override void OnInitialized()
    {
        pathSettings.OnChange((s, v) =>
        {
            InvokeAsync(() => StateHasChanged());
        });
    }
    private void ClearGeckoDriver()
    {
        SettingsWriter.AddOrUpdateAppSetting("DriverPathSettings:GeckoDriverPath", "");
    }
    private void LoadGeckoDriver()
    {
        ErrorsList.Clear();
        FolderBrowserDialog folderBrowserDialog = new FolderBrowserDialog();
        folderBrowserDialog.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
        DialogResult res = folderBrowserDialog.ShowDialog();
        if (res == DialogResult.OK)
        {
            SettingsWriter.AddOrUpdateAppSetting("DriverPathSettings:GeckoDriverPath", folderBrowserDialog.SelectedPath);
        }
        else
        {
            ErrorsList.Add(res.ToString());
        }
    }
    private void LoadFirefoxALLEProfile() => LoadFirefoxProfile("ALLE");
    private void LoadFirefoxANNEProfile() => LoadFirefoxProfile("ANNE");
    private void LoadFirefoxBACIProfile() => LoadFirefoxProfile("BACI");
    private void LoadFirefoxBACOProfile() => LoadFirefoxProfile("BACO");
    private void LoadFirefoxCALVProfile() => LoadFirefoxProfile("CALV");
    private void LoadFirefoxCAROProfile() => LoadFirefoxProfile("CARO");
    private void LoadFirefoxCARRProfile() => LoadFirefoxProfile("CARR");
    private void LoadFirefoxCECIProfile() => LoadFirefoxProfile("CECI");
    private void LoadFirefoxCHARProfile() => LoadFirefoxProfile("CHAR");
    private void LoadFirefoxDORCProfile() => LoadFirefoxProfile("DORC");
    private void LoadFirefoxFREDProfile() => LoadFirefoxProfile("FRED");
    private void LoadFirefoxGARRProfile() => LoadFirefoxProfile("GARR");
    private void LoadFirefoxHARFProfile() => LoadFirefoxProfile("HARF");
    private void LoadFirefoxHOWAProfile() => LoadFirefoxProfile("HOWA");
    private void LoadFirefoxKENTProfile() => LoadFirefoxProfile("KENT");
    private void LoadFirefoxMONTProfile() => LoadFirefoxProfile("MONT");
    private void LoadFirefoxPRINProfile() => LoadFirefoxProfile("PRIN");
    private void LoadFirefoxQUEEProfile() => LoadFirefoxProfile("QUEE");
    private void LoadFirefoxSOMEProfile() => LoadFirefoxProfile("SOME");
    private void LoadFirefoxSTMAProfile() => LoadFirefoxProfile("STMA");
    private void LoadFirefoxTALBProfile() => LoadFirefoxProfile("TALB");
    private void LoadFirefoxWASHProfile() => LoadFirefoxProfile("WASH");
    private void LoadFirefoxWICOProfile() => LoadFirefoxProfile("WICO");
    private void LoadFirefoxWORCProfile() => LoadFirefoxProfile("WORC");
    private void LoadFirefoxProfile(string county)
    {
        ErrorsList.Clear();
        FolderBrowserDialog folderBrowserDialog = new FolderBrowserDialog();
        folderBrowserDialog.InitialDirectory = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
        DialogResult res = folderBrowserDialog.ShowDialog();
        if (res == DialogResult.OK)
        {
            SettingsWriter.AddOrUpdateAppSetting($"DriverPathSettings:Firefox{county}ProfilePath", folderBrowserDialog.SelectedPath);
        }
        else
        {
            ErrorsList.Add(res.ToString());
        }
    }
    private void ClearFirefoxALLEProfile() => ClearFirefoxProfile("ALLE");
    private void ClearFirefoxANNEProfile() => ClearFirefoxProfile("ANNE");
    private void ClearFirefoxBACIProfile() => ClearFirefoxProfile("BACI");
    private void ClearFirefoxBACOProfile() => ClearFirefoxProfile("BACO");
    private void ClearFirefoxCALVProfile() => ClearFirefoxProfile("CALV");
    private void ClearFirefoxCAROProfile() => ClearFirefoxProfile("CARO");
    private void ClearFirefoxCARRProfile() => ClearFirefoxProfile("CARR");
    private void ClearFirefoxCECIProfile() => ClearFirefoxProfile("CECI");
    private void ClearFirefoxCHARProfile() => ClearFirefoxProfile("CHAR");
    private void ClearFirefoxDORCProfile() => ClearFirefoxProfile("DORC");
    private void ClearFirefoxFREDProfile() => ClearFirefoxProfile("FRED");
    private void ClearFirefoxGARRProfile() => ClearFirefoxProfile("GARR");
    private void ClearFirefoxHARFProfile() => ClearFirefoxProfile("HARF");
    private void ClearFirefoxHOWAProfile() => ClearFirefoxProfile("HOWA");
    private void ClearFirefoxKENTProfile() => ClearFirefoxProfile("KENT");
    private void ClearFirefoxMONTProfile() => ClearFirefoxProfile("MONT");
    private void ClearFirefoxPRINProfile() => ClearFirefoxProfile("PRIN");
    private void ClearFirefoxQUEEProfile() => ClearFirefoxProfile("QUEE");
    private void ClearFirefoxSOMEProfile() => ClearFirefoxProfile("SOME");
    private void ClearFirefoxSTMAProfile() => ClearFirefoxProfile("STMA");
    private void ClearFirefoxTALBProfile() => ClearFirefoxProfile("TALB");
    private void ClearFirefoxWASHProfile() => ClearFirefoxProfile("WASH");
    private void ClearFirefoxWICOProfile() => ClearFirefoxProfile("WICO");
    private void ClearFirefoxWORCProfile() => ClearFirefoxProfile("WORC");
    private void ClearFirefoxProfile(string county)
    {
        SettingsWriter.AddOrUpdateAppSetting($"DriverPathSettings:Firefox{county}ProfilePath", "");
    }
    private static class SettingsWriter
    {
        internal static void AddOrUpdateAppSetting(string sectionPathKey, string value)
        {
            try
            {
                var filePath = Path.Combine(System.AppContext.BaseDirectory, "appsettings.json");
                string json = File.ReadAllText(filePath);
                JsonObject jsonObj = JsonSerializer.Deserialize<JsonObject>(json);
                SetValueRecursively(sectionPathKey, jsonObj, value);
                string output = JsonSerializer.Serialize(jsonObj, new JsonSerializerOptions() { WriteIndented = true });
                File.WriteAllText(filePath, output);
            }
            catch (Exception ex)
            {
                Serilog.Log.Information($"Error writing app settings | {0}", ex.Message);
            }
        }

        private static void SetValueRecursively(string sectionPathKey, JsonNode jsonObj, string value)
        { // split the string at the first ':' character
            var remainingSections = sectionPathKey.Split(":", 2);
            var currentSection = remainingSections[0];
            if (remainingSections.Length > 1)
            {
                // continue with the procress, moving down the tree
                var nextSection = remainingSections[1];
                SetValueRecursively(nextSection, jsonObj[currentSection], value);
            }
            else
            {
                // we've got to the end of the tree, set the value
                jsonObj[currentSection] = value;
            }
        }
    }
}
